:sourcesdir: ../../../../../source

[[screen_mixins]]
===== Примеси экранов

Примеси позволяют создавать функциональность, которая может быть переиспользована в разных экранах без необходимости наследования этих экранов от общих базовых классов.
Примеси реализуются с помощью интерфейсов Java с default-методами.

Примеси имеют следующие характеристики:

* Экран может иметь несколько примесей.

* В интерфейсе примеси можно подписываться на <<screen_controller_events,события экрана>>.

* Если необходимо, примесь может сохранять некоторое состояние в экране.

* Примесь может обращаться к компонентам экрана и инфраструктурным бинам, например <<gui_dialogs,Dialogs>>, <<gui_notifications,Notifications>>, и пр.

* Для параметризации поведения примеси, она может полагаться на аннотации экрана или вводить абстрактные методы, которые должен будет реализовать экран.

Обычно использование примеси заключается просто в реализации определенного интерфейса в контроллере экрана. В примере ниже, экран `CustomerEditor` получает функциональность примесей, реализованных интерфейсами `HasComments`, `HasHistory` и `HasAttachments`:

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_usage_1.java[]
----

Примесь может использовать следующие классы для работы с экраном и инфраструктурой:

* `com.haulmont.cuba.gui.screen.Extensions` предоставляет статические методы для сохранения и извлечения состояния из экрана, в котором примесь используется, а также для получения бина `BeanLocator`, который в свою очередь позволяет получить любой Spring бин.

* `UiControllerUtils` предоставляет доступ к UI-компонентам и компонентам данных экрана.

В примерах ниже демонстрируется создание и использование примесей.

[[screen_mixin_banner]]
Примесь Banner::
+
--
Это очень простая примесь, которая отображает надпись вверху экрана.

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_banner_1.java[]
----
<1> - получение `BeanLocator`.
<2> - получение фабрики UI-компонентов.
<3> - создание компонента `Label` и установка его параметров.
<4> - добавление компонента `Label` в корневой UI-компонент экрана.

Примесь может быть использована следующим образом:

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_banner_2.java[]
----
--

[[screen_mixin_declarative_loader_params]]
Примесь DeclarativeLoaderParameters::
+
--
Следующая примесь помогает устанавливать отношения master-detail между контейнерами данных. Обычно для этого необходимо подписаться на `ItemChangeEvent` master-контейнера и задать параметр для detail-загрузчика, как описано в разделе <<gui_data_comp_dep>>. Примесь сможет сделать это автоматически, если параметр будет иметь специальное имя, указывающее на master-контейнер.

Создаваемая примесь будет использовать объект-состояние для передачи информации между обработчиками событий экрана. Это сделано в основном для целей демонстрации, так как в данном случае можно было бы разместить всю логику в единственном обработчике `BeforeShowEvent`.

Сначала создадим класс объекта состояния. Он содержит единственное поле для сохранения набора загрузчиков, которые должны сработать в обработчике `BeforeShowEvent`:

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_DeclarativeLoaderParameters_1.java[]
----

Теперь создадим интерфейс примеси:

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_DeclarativeLoaderParameters_2.java[]
----
<1> - подписка на <<screen_InitEvent,InitEvent>>.
<2> - получение объекта `ScreenData`, в котором зарегистрированы все контейнеры и загрузчики данных, объявленные в XML-дескрипторе.
<3> - проверка, соответствует ли имя параметра загрузчика паттерну`:container$masterContainerId`.
<4> - извлечение id master-контейнера из имени параметра и регистрация обработчика `ItemChangeEvent` для этого контейнера.
<5> - перезагрузка detail-загрузчика для нового выбранного элемента в master-контейнере.
<6> - добавление master-загрузчика в набор для вызова позже в обработчике `BeforeShowEvent`.
<7> - создание объекта состояния и сохранение его в экране с помощью класса `Extensions`.
<8> - подписка на <<screen_BeforeShowEvent,BeforeShowEvent>>.
<9> - вызов всех master-загрузчиков в обработчике `InitEvent`.

Определим master и detail контейнеры и загрузчики в XML-дескрипторе экрана. Detail-загрузчик должен иметь параметр с именем вида `:container$masterContainerId`:

[source, xml]
----
include::{sourcesdir}/gui/screens/mixin_DeclarativeLoaderParameters_3.xml[]
----

В контроллере экрана достаточно добавить интерфейс примеси, и она будет вызывать загрузчики нужным образом:

[source, java]
----
include::{sourcesdir}/gui/screens/mixin_DeclarativeLoaderParameters_4.java[]
----
--
